[gcode_macro ENDLESS_RUNOUT]
gcode:
    {% set t = params.T|int %}

    {% set settings = get_macro_variables("ENDLESS_SETTINGS") %}
    {% set num_tools = printer["gcode_macro MMMS_SETTINGS"].num_tools %}
    {% set current_group = settings["t"+(t|string)] %}

    {% set found = False %}

    RESPOND MSG="Endless Spool Runout!"

    {% for tool in range(num_tools) %}
        {% if tool != t and not found %}
            {% set group = settings["t"+(tool|string)] %}
            {% if group == current_group %}
                M117 Endless Spool Recovering...

                MMMS_UNLOAD
                MMMS_UNLOAD

                SYNC_TOOL TOOL={tool}
                MMMS_LOAD

                M117 Endless Spool Recovered

                {% set found = True %}
            {% endif %}
        {% endif %}
    {% endfor %}

    {% if not found %}
        M117 Filament Runout T{t}
        PAUSE
    {% endif %}