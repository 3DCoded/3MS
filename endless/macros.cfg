[gcode_macro ENDLESS_RUNOUT]
gcode:
    {% set p = printer.save_variables.variables.p|int %}
    {% set t = params.T|default(p)|int %}

    {% set settings = get_macro_variables("ENDLESS_SETTINGS") %}
    {% set num_tools = printer["gcode_macro MMMS_SETTINGS"].num_tools %}
    {% set load_distance = printer["gcode_macro MMMS_SETTINGS"].load_distance %}
    {% set load_speed = printer["gcode_macro MMMS_SETTINGS"].load_speed %}
    {% set current_group = settings["t"+(t|string)] %}
    {% set single = settings["single"]|int %}

    {% set found = False %}

    RESPOND MSG="Endless Spool Runout!"

    {% for tool in range(num_tools) %}
        {% if tool != t and not found %}
            {% set group = settings["t"+(tool|string)] %}
            {% if group == current_group %}
                M117 Endless Spool Recovering...
                
                {% if single %}
                    SYNC_TOOL TOOL={tool}
                    FORCE_MOVE STEPPER="extruder_stepper 3ms{tool}" DISTANCE={load_distance+10} SPEED={load_speed}
                {% else %}
                    DISABLE_FSENSOR

                    MMMS_UNLOAD
                    MMMS_UNLOAD

                    ENABLE_FSENSOR
                    CHECK_FSENSOR V=0 MSG="Please unload T{t} and resume."

                    DISABLE_FSENSOR

                    SYNC_TOOL TOOL={tool}
                    MMMS_LOAD

                    ENABLE_FSENSOR
                    CHECK_FSENSOR V=1 MSG="Please load T{tool} to the nozzle and resume."
                {% endif %}

                SET_GCODE_VARIABLE MACRO=ENDLESS_SETTINGS VARIABLE=t{tool} VALUE=-1

                M117 Endless Spool Recovered

                {% set found = True %}
            {% endif %}
        {% endif %}
    {% endfor %}

    {% if not found %}
        M117 Filament Runout T{t}
        PAUSE
    {% endif %}